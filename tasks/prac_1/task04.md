Найти всех абонентов, у которых величина АП на последний день предыдущего месяца уменьшилась с последнего дня месяца полгода назад. Результат: номер договора, разница между АП на последний день предыдущего месяца и на последний день месяца полгода назад, наименования тарифных планов абонента на последний день предыдущего месяца и на последний день месяца полгода назад.

```sql
SELECT TMP_TOTAL_1.ID_CONTRACT AS ID_CONTRACT, TMP_TOTAL_1.N_TOTAL_COST - TMP_TOTAL_6.N_TOTAL_COST AS N_DELTA,
TMP_NAME_1.V_NAME AS V_NAME_1, TMP_NAME_6.V_NAME AS V_NAME_6
FROM (

SELECT FC.ID_CONTRACT_INST AS ID_CONTRACT, SUM(FSC.N_COST_PERIOD) AS N_TOTAL_COST
    FROM FW_CONTRACTS FC
JOIN FW_SERVICES_COST FSC
    ON FC.ID_CONTRACT_INST = FSC.ID_CONTRACT_INST AND
        FSC.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY AND
        TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY < FSC.DT_STOP
WHERE FC.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY AND
    TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY < FC.DT_STOP AND FC.V_STATUS = 'A'
GROUP BY FC.ID_CONTRACT_INST

) TMP_TOTAL_1
JOIN (

SELECT FC.ID_CONTRACT_INST AS ID_CONTRACT, SUM(FSC.N_COST_PERIOD) AS N_TOTAL_COST
    FROM FW_CONTRACTS FC
JOIN FW_SERVICES_COST FSC
    ON FC.ID_CONTRACT_INST = FSC.ID_CONTRACT_INST AND
        FSC.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY AND
        TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY < FSC.DT_STOP
WHERE FC.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY AND
    TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY < FC.DT_STOP AND FC.V_STATUS = 'A'
GROUP BY FC.ID_CONTRACT_INST

) TMP_TOTAL_6
ON TMP_TOTAL_1.ID_CONTRACT = TMP_TOTAL_6.ID_CONTRACT AND
    TMP_TOTAL_6.N_TOTAL_COST > TMP_TOTAL_1.N_TOTAL_COST
JOIN (

SELECT FC.ID_CONTRACT_INST AS ID_CONTRACT, FTP.V_NAME AS V_NAME
    FROM FW_CONTRACTS FC
JOIN FW_SERVICES FS
    ON FC.ID_CONTRACT_INST = FS.ID_CONTRACT_INST AND
        FS.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY AND
        TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY < FS.DT_STOP AND FS.B_DELETED = 0 AND FS.V_STATUS = 'A'
JOIN FW_TARIFF_PLAN FTP
    ON FS.ID_TARIFF_PLAN = FTP.ID_TARIFF_PLAN AND
        FTP.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY AND
        TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY < FTP.DT_STOP AND FTP.B_DELETED = 0
WHERE FC.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY AND
    TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' DAY < FC.DT_STOP AND FC.V_STATUS = 'A'

) TMP_NAME_1
ON TMP_TOTAL_6.ID_CONTRACT = TMP_NAME_1.ID_CONTRACT
JOIN (

SELECT FC.ID_CONTRACT_INST AS ID_CONTRACT, FTP.V_NAME AS V_NAME
    FROM FW_CONTRACTS FC
JOIN FW_SERVICES FS
    ON FC.ID_CONTRACT_INST = FS.ID_CONTRACT_INST AND
        FS.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY AND
        TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY < FS.DT_STOP AND FS.B_DELETED = 0 AND
        FS.V_STATUS = 'A'
JOIN FW_TARIFF_PLAN FTP
    ON FS.ID_TARIFF_PLAN = FTP.ID_TARIFF_PLAN AND
        FTP.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY AND
        TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY < FTP.DT_STOP AND FTP.B_DELETED = 0
WHERE FC.DT_START <= TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY AND
    TRUNC(CURRENT_TIMESTAMP, 'MONTH') - INTERVAL '1' MONTH - INTERVAL '1' DAY < FC.DT_STOP AND FC.V_STATUS = 'A'

) TMP_NAME_6
ON TMP_NAME_1.ID_CONTRACT = TMP_NAME_6.ID_CONTRACT;
```
