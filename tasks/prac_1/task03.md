Найти всех абонентов, у которых величина скидки на услугах менялась 2 и более раз в течение ноября 2017. Результат: номер договора, сумма АП на текущий момент, услуга, количество изменений величины скидок на услуге.

```sql
SELECT TMP_CHANGE.ID_CONTRACT AS ID_CONTRACT, TMP_TOTAL.N_TOTAL_COST AS N_TOTAL_COST,
TMP_CHANGE.ID_SERVICE AS ID_SERVICE, TMP_CHANGE.N_CHANGE AS N_CHANGE
    FROM (

SELECT FC.ID_CONTRACT_INST AS ID_CONTRACT, FSC.ID_SERVICE_INST AS ID_SERVICE,
COUNT(DISTINCT FSC.N_DISCOUNT_PERIOD) AS N_CHANGE
    FROM FW_CONTRACTS FC
JOIN FW_SERVICES_COST FSC
    ON FC.ID_CONTRACT_INST = FSC.ID_CONTRACT_INST AND
        TO_DATE('01.11.2017', 'dd.mm.yyyy') <= FSC.DT_STOP AND FSC.DT_START < TO_DATE('01.12.2017', 'dd.mm.yyyy')
WHERE TO_DATE('01.11.2017', 'dd.mm.yyyy') <= FC.DT_STOP AND FC.DT_START < TO_DATE('01.12.2017', 'dd.mm.yyyy')
GROUP BY FC.ID_CONTRACT_INST, FSC.ID_SERVICE_INST
HAVING COUNT(DISTINCT FSC.N_DISCOUNT_PERIOD) >= 2

) TMP_CHANGE

JOIN (

SELECT FC.ID_CONTRACT_INST AS ID_CONTRACT, SUM(FSC.N_COST_PERIOD) AS N_TOTAL_COST
    FROM FW_CONTRACTS FC
JOIN FW_SERVICES_COST FSC
    ON FC.ID_CONTRACT_INST = FSC.ID_CONTRACT_INST AND
        FSC.DT_START <= CURRENT_TIMESTAMP AND CURRENT_TIMESTAMP < FSC.DT_STOP
WHERE FC.DT_START <= CURRENT_TIMESTAMP AND CURRENT_TIMESTAMP < FC.DT_STOP AND FC.V_STATUS = 'A'
GROUP BY FC.ID_CONTRACT_INST

) TMP_TOTAL
ON TMP_CHANGE.ID_CONTRACT = TMP_TOTAL.ID_CONTRACT;

```
